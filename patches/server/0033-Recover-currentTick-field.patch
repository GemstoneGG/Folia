From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: killerprojecte <admin@fastmcmirror.org>
Date: Tue, 4 Jul 2023 13:09:39 +0800
Subject: [PATCH] Recover currentTick field


diff --git a/src/main/java/io/papermc/paper/chunk/system/scheduling/ChunkHolderManager.java b/src/main/java/io/papermc/paper/chunk/system/scheduling/ChunkHolderManager.java
index ae9b199bf36dd98a8e30ea679b79127184dc7d19..6135ff463327a4753bf06d2481fdff5ae5b99d61 100644
--- a/src/main/java/io/papermc/paper/chunk/system/scheduling/ChunkHolderManager.java
+++ b/src/main/java/io/papermc/paper/chunk/system/scheduling/ChunkHolderManager.java
@@ -904,6 +904,12 @@ public final class ChunkHolderManager {
             }
         }
 
+        if (region.getData().world.serverLevelData.getLevelName().equalsIgnoreCase("world")) {
+            // DirtyFolia - update currentTick
+            MinecraftServer.currentTick = (int) region.getData().getCurrentTick();
+            MinecraftServer.currentTickLong = region.getData().getCurrentTick();
+        }
+
         this.processTicketUpdates();
     }
 
diff --git a/src/main/java/net/minecraft/server/MinecraftServer.java b/src/main/java/net/minecraft/server/MinecraftServer.java
index 6b259a38522c4d09319eba3d73a4863e8b69794f..a0b28cc311f996f48cdd632a1512c7cc06d2db59 100644
--- a/src/main/java/net/minecraft/server/MinecraftServer.java
+++ b/src/main/java/net/minecraft/server/MinecraftServer.java
@@ -231,7 +231,7 @@ public abstract class MinecraftServer extends ReentrantBlockableEventLoop<TickTa
     public org.bukkit.command.ConsoleCommandSender console;
     public org.bukkit.command.RemoteConsoleCommandSender remoteConsole;
     //public ConsoleReader reader; // Paper
-    //public static int currentTick = 0; // Paper - Further improve tick loop // Folia - region threading
+    public static int currentTick = 0; // Paper - Further improve tick loop // Folia - region threading // DirtyFolia - Recover API
     public java.util.Queue<Runnable> processQueue = new java.util.concurrent.ConcurrentLinkedQueue<Runnable>();
     public int autosavePeriod;
     public Commands vanillaCommandDispatcher;
@@ -244,7 +244,7 @@ public abstract class MinecraftServer extends ReentrantBlockableEventLoop<TickTa
     public final double[] recentTps = new double[ 3 ];
     // Spigot end
     public final io.papermc.paper.configuration.PaperConfigurations paperConfigurations;
-    //public static long currentTickLong = 0L; // Paper // Folia - threaded regions
+    public static long currentTickLong = 0L; // Paper // Folia - threaded regions // DirtyFolia - Recover API
 
     public volatile Thread shutdownThread; // Paper
     public volatile boolean abnormalExit = false; // Paper
